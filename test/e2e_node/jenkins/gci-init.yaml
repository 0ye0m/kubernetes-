#cloud-config

runcmd:
  - mount /tmp /tmp -o remount,exec,suid
  - usermod -a -G docker jenkins
  - mkdir -p /var/lib/kubelet
  - mkdir -p /home/kubernetes/mounter-rootfs
  - chmod a+x /home/kubernetes/mounter-rootfs
  - wget https://storage.googleapis.com/kubernetes-release/gci-mounter/mounter.tar -O /tmp/mounter.tar
  - tar xvf /tmp/mounter.tar -C /home/kubernetes/mounter-rootfs
  - mkdir /home/kubernetes/mounter-rootfs/var/lib/kubelet
  - mount --bind /home/kubernetes/mounter-rootfs /home/kubernetes/mounter-rootfs
  - mount -o remount, exec /home/kubernetes/mounter-rootfs
  - mount --rbind /var/lib/kubelet /home/kubernetes/mounter-rootfs/var/lib/kubelet
  - mount --make-rshared /home/kubernetes/mounter-rootfs/var/lib/kubelet
  - mount --rbind /proc /home/kubernetes/mounter-rootfs/proc
  - mount --rbind /dev /home/kubernetes/mounter-rootfs/dev
