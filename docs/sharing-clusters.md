# Sharing Cluster Access

Client access to a running lmktfy cluster can be shared by copying
the `lmktfyctl` client config bundle ([.lmktfyconfig](lmktfyconfig-file.md)).
This config bundle lives in `$HOME/.lmktfy/.lmktfyconfig`, and is generated
by `cluster/lmktfy-up.sh`. Sample steps for sharing `.lmktfyconfig` below.

**1. Create a cluster**
```bash
cluster/lmktfy-up.sh
```
**2. Copy .lmktfyconfig to new host**
```bash
scp $HOME/.lmktfy/.lmktfyconfig user@remotehost:/path/to/.lmktfyconfig
```

**3. On new host, make copied `.lmktfyconfig` available to `lmktfyctl`**

* Option A: copy to default location
```bash
mv /path/to/.lmktfyconfig $HOME/.lmktfy/.lmktfyconfig
```
* Option B: copy to working directory (from which lmktfyctl is run)
```bash
mv /path/to/.lmktfyconfig $PWD
```
* Option C: manually pass `.lmktfyconfig` location to `.lmktfyctl`
```bash
# via environment variable
export LMKTFYCONFIG=/path/to/.lmktfyconfig

# via commandline flag
lmktfyctl ... --lmktfyconfig=/path/to/.lmktfyconfig
```

## Manually Generating `.lmktfyconfig`

`.lmktfyconfig` is generated by `lmktfy-up` but you can generate your own
using (any desired subset of) the following commands.

```bash
# create lmktfyconfig entry
lmktfyctl config set-cluster $CLUSTER_NICK
    --server=https://1.1.1.1 \
    --certificate-authority=/path/to/apiserver/ca_file \
    --embed-certs=true \
    # Or if tls not needed, replace --certificate-authority and --embed-certs with
    --insecure-skip-tls-verify=true
    --lmktfyconfig=/path/to/standalone/.lmktfyconfig

# create user entry
lmktfyctl config set-credentials $USER_NICK
    # basic auth credentials, generated on lmktfy master
    --username=$username \
    --password=$password \
    # use either username|password or token, not both
    --token=$token \
    --client-certificate=/path/to/crt_file \
    --client-key=/path/to/key_file \
    --embed-certs=true
    --lmktfyconfig=/path/to/standalone/.lmktfyconfig

# create context entry
lmktfyctl config set-context $CONTEXT_NAME --cluster=$CLUSTER_NICKNAME --user=$USER_NICK
```
Notes:
* The `--embed-certs` flag is needed to generate a standalone
`.lmktfyconfig`, that will work as-is on another host.
* `--lmktfyconfig` is both the preferred file to load config from and the file to
save config too. In the above commands the `--lmktfyconfig` file could be
omitted if you first run
```bash
export LMKTFYCONFIG=/path/to/standalone/.lmktfyconfig
```
* The ca_file, key_file, and cert_file referrenced above are generated on the
lmktfy master at cluster turnup. They can be found on the master under
`/srv/lmktfy`. Basic auth/token are also generated on the lmktfy master.

For more details on `.lmktfyconfig` see [lmktfyconfig-file.md](lmktfyconfig-file.md),
and/or run `lmktfyctl config -h`.

## Merging `.lmktfyconfig` Example

`lmktfyctl` loads and merges config from the following locations (in order)

1. `--lmktfyconfig=path/to/lmktfyconfig` commandline flag
2. `LMKTFYCONFIG=path/to/lmktfyconfig` env variable
3. `$PWD/.lmktfyconfig`
4. `$HOME/.lmktfy/.lmktfyconfig`

If you create clusters A, B on host1, and clusters C, D on host2, you can
make all four clusters available on both hosts by running

```bash
# on host2, copy host1's default lmktfyconfig, and merge it from env
scp host1:/path/to/home1/.lmktfy/.lmktfyconfig path/to/other/.lmktfyconfig

export $LMKTFYCONFIG=path/to/other/.lmktfyconfig

# on host1, copy host2's default lmktfyconfig and merge it from env
scp host2:/path/to/home2/.lmktfy/.lmktfyconfig path/to/other/.lmktfyconfig

export $LMKTFYCONFIG=path/to/other/.lmktfyconfig
```
Detailed examples and explanation of `.lmktfyconfig` loading/merging rules can be found in [lmktfyconfig-file.md](https://github.com/GoogleCloudPlatform/lmktfy/blob/master/docs/lmktfyconfig-file.md).

